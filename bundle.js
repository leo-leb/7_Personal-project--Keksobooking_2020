(()=>{"use strict";window.common={create:(e,t)=>{t.appendChild(e.cloneNode(!0))},escEvt:(e,t)=>{27===e.keyCode&&(e.preventDefault(),t())},enterEvt:(e,t)=>{13===e.keyCode&&(e.preventDefault(),t())},leftButtonEvt:(e,t)=>{1===e.which&&(e.preventDefault(),t())}},(()=>{let e;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e={1:"1",2:["1","2"],3:["1","2","3"],100:"0"},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},o=document.querySelector(".ad-form"),r=o.querySelectorAll("fieldset"),n=o.querySelector("#address"),i=o.querySelector("#title"),d=o.querySelector("#price"),a=o.querySelector("#room_number"),s=o.querySelector("#capacity"),l=o.querySelector("#type"),c=o.querySelector("#timein"),u=o.querySelector("#timeout"),m=document.querySelector("main"),w=document.querySelector("#success").content.querySelector(".success"),p=document.querySelector("#error").content.querySelector(".error"),f=document.querySelector(".error__button"),y=document.querySelector(".ad-form__reset"),v=document.querySelector(".ad-form__field input[type=file]"),h=document.querySelector(".ad-form-header__preview"),g=document.querySelector("#images"),_=document.querySelector(".ad-form__photo");s.addEventListener("change",(()=>{let t=a[a.selectedIndex].value,o=s[s.selectedIndex].value;e[t].includes(o)?s.setCustomValidity(""):s.setCustomValidity("Недоступно")})),i.addEventListener("input",(()=>{i.validity.tooShort?i.setCustomValidity("Заголовок должен состоять минимум из 30-и символов"):i.validity.tooLong?i.setCustomValidity("Заголовок должен состоять максимум из 100-а символов"):i.validity.valueMissing?i.setCustomValidity("Обязательное поле"):i.setCustomValidity(""),i.reportValidity()})),l.addEventListener("change",(()=>{let e=Object.keys(t),o=l[l.selectedIndex].value;o===e[0]||o===e[1]?(d.min=t[o],d.placeholder=t[o]):(e[2],d.min=t[o],d.placeholder=t[o])})),d.addEventListener("input",(()=>{d.validity.rangeUnderflow?d.setCustomValidity("Слишком низкая стоимость"):d.validity.rangeOverflow?d.setCustomValidity("Цена должна быть не более 1 000 000"):d.validity.valueMissing?d.setCustomValidity("Обязательное поле"):d.setCustomValidity(""),d.reportValidity()})),d.addEventListener("change",(()=>{d.validity.rangeUnderflow?d.setCustomValidity("Слишком низкая стоимость"):d.validity.rangeOverflow?d.setCustomValidity("Цена должна быть не более 1 000 000"):d.validity.valueMissing?d.setCustomValidity("Обязательное поле"):d.setCustomValidity(""),d.reportValidity()})),c.addEventListener("change",(()=>{u.selectedIndex=c.selectedIndex})),u.addEventListener("change",(()=>{c.selectedIndex=u.selectedIndex}));const S=e=>window.common.escEvt(e,q),E=e=>window.common.leftButtonEvt(e,q),q=()=>{document.querySelector(".success").remove(),document.removeEventListener("keydown",S),document.removeEventListener("mousedown",S)},L=e=>window.common.escEvt(e,C),k=e=>window.common.leftButtonEvt(e,C),C=()=>{document.querySelector(".error").remove(),document.removeEventListener("keydown",L),document.removeEventListener("mousedown",k)};y.addEventListener("keydown",(e=>window.common.leftButtonEvt(e,window.map.onPageLock()))),y.addEventListener("mousedown",(e=>window.common.enterEvt(e,window.map.onPageLock()))),window.form={parent:o,childs:r,address:n,title:i,avatarChoser:v,adPhotoChoser:g,mainButtonPress:()=>{window.map.onPageLock(),window.common.create(w,m),document.addEventListener("keydown",S),document.addEventListener("mousedown",E)},getError:()=>{!0===o.checkValidity()?(window.common.create(p,m),document.addEventListener("keydown",L),document.addEventListener("mousedown",k),f.addEventListener("mousedown",k)):o.reportValidity()},onAvatarChose:function(){window.image.load(v,h)},onPhotoChose:function(){window.image.load(g,_)}}})(),(()=>{const e=(e,t,o)=>{e.responseType="json",e.timeout=1e3,e.addEventListener("load",(()=>{let r;switch(e.status){case 200:t(e.response);break;case 400:r="Неверный запрос";break;case 401:r="Пользователь не авторизован";break;case 404:r="Ничего не найдено";break;default:r="Cтатус ответа: : "+e.status+" "+e.statusText}r&&o(r)})),e.addEventListener("error",(()=>o("Произошла ошибка соединения"))),e.addEventListener("timeout",(()=>o("Запрос не успел выполниться за "+e.timeout+"мс")))};window.server={url:{load:"https://21.javascript.pages.academy/keksobooking",download:"https://21.javascript.pages.academy/keksobooking/data"},error:e=>{const t=document.createElement("div");t.textContent=e,t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",document.body.insertAdjacentElement("beforebegin",t)},download:(t,o,r)=>{let n=new XMLHttpRequest;e(n,o,r),n.open("GET",t),n.send()},load:(t,o,r)=>{const n=document.querySelector(".ad-form"),i=new FormData(n);let d=new XMLHttpRequest;e(d,o,r),d.open("POST",t),d.send(i)}}})(),(()=>{const e=document.querySelector(".map");window.pin={fill:(e,t)=>{e.style=`left: ${t.location.x}px; top: ${t.location.y}px`;let o=e.querySelector("img");o.src=""+t.author.avatar,o.alt="заголовок объявления"},remove:()=>{window.map.elementsParent.querySelectorAll("button:not(.map__pin--main):not(.popup__close)").forEach((e=>{e.remove()}))},set:(e,t)=>{e.style.left=t.X+"px",e.style.top=t.Y+"px"},calcReal:(t,o)=>({X:Math.floor(e.offsetWidth/2-t/2),Y:Math.floor(e.offsetHeight/2-o/2)}),calcFakeCircle:(e,t,o)=>({X:Math.ceil(e.X+t/2),Y:Math.ceil(e.Y+o/2)}),calcFakePin:(e,t,o)=>({X:Math.ceil(e.X+t/2),Y:Math.ceil(e.Y+o)})}})(),(()=>{const e=["wifi","dishwasher","parking","washer","elevator","conditioner"],t={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},o=(e,t,o)=>{0!==t.length||e.remove()},r=(e,t)=>{e.textContent=t};window.card={fill:(n,i)=>{let d=n.querySelector(".popup__title");o(d,i.offer.title,r(d,i.offer.title));let a=n.querySelector(".popup__text--address");o(a,i.offer.address,r(a,i.offer.address));let s=n.querySelector(".popup__type");o(s,i.offer.type,r(s,t[i.offer.type]));let l=n.querySelector(".popup__description");o(l,i.offer.description,r(l,i.offer.description));let c=n.querySelector(".popup__text--price");o(c,i.offer.price,c.textContent=i.offer.price+"₽/ночь");let u=n.querySelector(".popup__text--capacity");o(u,i.offer.rooms,u.textContent=`${i.offer.rooms} комнаты для ${i.offer.guests} гостей`);let m=n.querySelector(".popup__text--time");o(m,i.offer.checkin,m.textContent=`Заезде после ${i.offer.checkin}, выезд до ${i.offer.checkout}`);let w=n.querySelector(".popup__avatar");o(w,i.author.avatar,w.src=""+i.author.avatar);let p=n.querySelector(".popup__features"),f=p.querySelectorAll(".popup__feature");if(0!==i.offer.features.length)for(let t=0;t<i.offer.features.length;t++)!1===i.offer.features.includes(e[t])&&f[t].remove();else p.remove();let y=n.querySelector(".popup__photos"),v=y.querySelector(".popup__photo");if(0!==i.offer.photos.length){v.src=""+i.offer.photos[0];for(let e=1;e<i.offer.photos.length;e++)window.common.create(v,y),v.src=""+i.offer.photos[e]}else y.remove()},remove:()=>{window.map.elementsParent.querySelectorAll(".map__card").forEach((e=>{e.remove()}))},hide:()=>{window.map.elementsParent.querySelectorAll(".map__card").forEach((e=>{e.style.display="none"}))}}})(),(()=>{let e;const t=document.querySelector(".map__filters"),o=Array.from(t.children),r={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},n={"housing-type":(e,t)=>t.value===e.offer.type,"housing-rooms":(e,t)=>t.value===e.offer.rooms.toString(),"housing-guests":(e,t)=>t.value===e.offer.guests.toString(),"housing-price":(e,t)=>e.offer.price>=r[t.value].start&&e.offer.price<r[t.value].end,"housing-features":(e,t)=>Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((t=>e.offer.features.some((e=>e===t.value))))},i=e=>e.filter((e=>o.every((t=>"any"===t.value||n[t.id](e,t)))));t.addEventListener("change",(()=>{window.map.clear();let t=i(e);window.debounce((()=>window.map.fill(t,5)))})),window.filter={success:t=>{e=t;let o=i(e);window.map.fill(o,5)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.image={load:(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((function(e){return n.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){if(null===o.querySelector("img")){const t=document.createElement("img");t.src=e.result,t.alt="Фото объявления",t.style="width: 65px; height: 65px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)",o.style.position="relative",o.appendChild(t)}else o.querySelector("img").src=e.result})),e.readAsDataURL(r)}}}})(),(()=>{const e={X:65,Y1:65,Y2:82},t=document.querySelector(".map"),o=t.querySelector(".map__filters"),r=o.querySelectorAll(".map__filter"),n=document.querySelector(".map__pins"),i=n.querySelector(".map__pin--main"),d=window.pin.calcReal(e.X,e.Y1),a=document.querySelector("#pin").content.querySelector(".map__pin"),s=document.querySelector("#card").content.querySelector(".map__card"),l=e=>window.common.enterEvt(e,u),c=e=>window.common.leftButtonEvt(e,u),u=()=>{t.classList.remove("map--faded"),window.form.parent.classList.remove("ad-form--disabled"),r.forEach((e=>e.removeAttribute("disabled",!0))),window.form.childs.forEach((e=>e.removeAttribute("disabled",!0)));const o=window.pin.calcFakePin(d,e.X,e.Y2);window.form.address.value=`${o.X}, ${o.Y}`,window.server.download(window.server.url.download,window.filter.success,window.server.error),i.removeEventListener("mousedown",c),i.removeEventListener("keydown",l),window.form.avatarChoser.addEventListener("change",window.form.onAvatarChose),window.form.adPhotoChoser.addEventListener("change",window.form.onPhotoChose)};window.map={elementsParent:n,mainPin:i,MainPinSizes:e,clear:()=>{window.pin.remove(),window.card.remove()},fill:(e,t)=>{for(let o=0;o<e.length&&o<t;o++)window.common.create(a,n),window.common.create(s,n);const o=n.querySelectorAll("button:not(.map__pin--main):not(.popup__close)"),r=n.querySelectorAll(".map__card");window.card.hide();for(let n=0;n<e.length&&n<t;n++){let t=o[n],i=r[n],d=i.querySelector(".popup__close");window.pin.fill(t,e[n]),window.card.fill(i,e[n]);const a=()=>{i.style.display="none",document.removeEventListener("keydown",s)},s=e=>{window.common.escEvt(e,a)},l=()=>{window.card.hide(),i.style.display="block",d.addEventListener("click",a),document.addEventListener("keydown",s)};t.addEventListener("click",l)}},onPageLock:()=>{window.map.clear(),window.form.parent.reset(),o.reset(),t.classList.add("map--faded"),window.form.parent.classList.add("ad-form--disabled"),r.forEach((e=>e.setAttribute("disabled",!0))),window.form.childs.forEach((e=>e.setAttribute("disabled",!0))),window.pin.set(i,d);const n=window.pin.calcFakeCircle(d,e.X,e.Y1);window.form.address.value=`${n.X}, ${n.Y}`,i.addEventListener("mousedown",c),i.addEventListener("keydown",l)}}})(),(()=>{const e=window.map.mainPin;e.addEventListener("mousedown",(t=>{t.preventDefault(),window.startCoords={X:t.clientX,Y:t.clientY};const o=t=>{t.preventDefault();let o=window.startCoords.X-t.clientX,r=window.startCoords.Y-t.clientY;window.startCoords={X:t.clientX,Y:t.clientY};let n=e.offsetLeft-o,i=e.offsetTop-r,d=Math.round(n+window.map.MainPinSizes.X/2),a=Math.round(i+window.map.MainPinSizes.Y2);0<=d&&d<=1200&&130<=a&&a<=630&&(e.style.top=i+"px",e.style.left=n+"px",window.form.address.value=`${d}, ${a}`)},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)}))})(),(()=>{const e=document.querySelector(".ad-form__submit");window.map.onPageLock(),e.addEventListener("click",(e=>{e.preventDefault(),window.server.load(window.server.url.load,window.form.mainButtonPress,window.form.getError)}))})()})();