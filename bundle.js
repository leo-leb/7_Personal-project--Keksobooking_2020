(()=>{"use strict";window.common={create:(e,t)=>{t.appendChild(e.cloneNode(!0))},escEvt:(e,t)=>{27===e.keyCode&&(e.preventDefault(),t())},enterEvt:(e,t)=>{13===e.keyCode&&(e.preventDefault(),t())},leftButtonEvt:(e,t)=>{1===e.which&&(e.preventDefault(),t())}},(()=>{let e;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=(e,t,o)=>{e.responseType="json",e.timeout=5e3,e.addEventListener("load",(()=>{let n;switch(e.status){case 200:t(e.response);break;case 400:n="Cтатус ответа: Неверный запрос";break;case 401:n="Cтатус ответа: Пользователь не авторизован";break;case 404:n="Cтатус ответа: Ничего не найдено";break;default:n="Cтатус ответа: "+e.status+" "+e.statusText}n&&o(n)})),e.addEventListener("error",(()=>o("Произошла ошибка соединения"))),e.addEventListener("timeout",(()=>o("Запрос не успел выполниться за "+e.timeout+"мс")))};window.server={url:{load:"https://21.javascript.pages.academy/keksobooking",download:"https://21.javascript.pages.academy/keksobooking/data"},error:e=>{const t=document.createElement("div");t.textContent=e,t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",document.body.insertAdjacentElement("beforebegin",t)},download:(t,o,n)=>{let r=new XMLHttpRequest;e(r,o,n),r.open("GET",t),r.send()},load:(t,o,n)=>{const r=document.querySelector(".ad-form"),d=new FormData(r);let i=new XMLHttpRequest;e(i,o,n),i.open("POST",t),i.send(d)}}})(),(()=>{const e={1:"1",2:["1","2"],3:["1","2","3"],100:"0"},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},o=document.querySelector(".ad-form"),n=o.querySelectorAll("fieldset"),r=o.querySelector("#address"),d=o.querySelector("#title"),i=o.querySelector("#price"),a=o.querySelector("#room_number"),s=o.querySelector("#capacity"),l=o.querySelector("#type"),c=o.querySelector("#timein"),u=o.querySelector("#timeout"),m=document.querySelector("main"),w=document.querySelector("#success").content.querySelector(".success"),p=document.querySelector("#error").content.querySelector(".error"),f=document.querySelector(".error__button"),v=document.querySelector(".ad-form__reset"),y=document.querySelector(".ad-form__field input[type=file]"),h=document.querySelector(".ad-form-header__preview"),E=document.querySelector("#images"),g=document.querySelector(".ad-form__photo"),S=function(){o.querySelectorAll("fieldset input[required]").forEach((function(e){e.style="box-shadow: 0 0 15px red",e.addEventListener("input",(function(){e.checkValidity()&&(e.style="box-shadow: 0")}))}))},_=function(){window.form.parent.checkValidity()?window.server.load(window.server.url.load,C,X):(S(),o.reportValidity())};s.addEventListener("change",(()=>{let t=a[a.selectedIndex].value,o=s[s.selectedIndex].value;e[t].includes(o)?s.setCustomValidity(""):s.setCustomValidity("Недоступно")})),d.addEventListener("input",(()=>{d.validity.tooShort?d.setCustomValidity("Заголовок должен состоять минимум из 30-и символов"):d.validity.tooLong?d.setCustomValidity("Заголовок должен состоять максимум из 100-а символов"):d.validity.valueMissing?d.setCustomValidity("Обязательное поле"):d.setCustomValidity(""),d.reportValidity()})),l.addEventListener("change",(()=>{let e=Object.keys(t),o=l[l.selectedIndex].value;o===e[0]||o===e[1]?(i.min=t[o],i.placeholder=t[o]):(e[2],i.min=t[o],i.placeholder=t[o])})),i.addEventListener("input",(()=>{i.validity.rangeUnderflow?i.setCustomValidity("Слишком низкая стоимость"):i.validity.rangeOverflow?i.setCustomValidity("Цена должна быть не более 1 000 000"):i.validity.valueMissing?i.setCustomValidity("Обязательное поле"):i.setCustomValidity(""),i.reportValidity()})),i.addEventListener("change",(()=>{i.validity.rangeUnderflow?i.setCustomValidity("Слишком низкая стоимость"):i.validity.rangeOverflow?i.setCustomValidity("Цена должна быть не более 1 000 000"):i.validity.valueMissing?i.setCustomValidity("Обязательное поле"):i.setCustomValidity(""),i.reportValidity()})),c.addEventListener("change",(()=>{u.selectedIndex=c.selectedIndex})),u.addEventListener("change",(()=>{c.selectedIndex=u.selectedIndex}));const q=e=>window.common.escEvt(e,k),L=e=>window.common.leftButtonEvt(e,k),k=()=>{document.querySelector(".success").remove(),document.removeEventListener("keydown",q),document.removeEventListener("mousedown",L)},C=()=>{window.map.onPageLock(),window.common.create(w,m),document.addEventListener("keydown",q),document.addEventListener("mousedown",L)},b=e=>window.common.escEvt(e,P),x=e=>window.common.leftButtonEvt(e,P),P=()=>{document.querySelector(".error").remove(),document.removeEventListener("keydown",b),document.removeEventListener("mousedown",x)},X=()=>{window.common.create(p,m),document.addEventListener("keydown",b),document.addEventListener("mousedown",x),f.addEventListener("mousedown",x)};v.addEventListener("keydown",(e=>window.common.leftButtonEvt(e,window.map.onPageLock()))),v.addEventListener("mousedown",(e=>window.common.enterEvt(e,window.map.onPageLock()))),window.form={parent:o,childs:n,address:r,title:d,avatarChoser:y,adPhotoChoser:E,showInvalid:S,onButtonPressEnter:e=>window.common.enterEvt(e,_),onButtonPressLeftMouse:e=>window.common.leftButtonEvt(e,_),onAvatarChose:function(){window.image.load(y,h)},onPhotoChose:function(){window.image.load(E,g)}}})(),(()=>{const e=document.querySelector(".map");window.pin={fill:(e,t)=>{e.style=`left: ${t.location.x}px; top: ${t.location.y}px`;let o=e.querySelector("img");o.src=""+t.author.avatar,o.alt="заголовок объявления"},remove:()=>{window.map.elementsParent.querySelectorAll("button:not(.map__pin--main):not(.popup__close)").forEach((e=>{e.remove()}))},set:(e,t)=>{e.style.left=t.X+"px",e.style.top=t.Y+"px"},calcReal:(t,o)=>({X:Math.floor(e.offsetWidth/2-t/2),Y:Math.floor(e.offsetHeight/2-o/2)}),calcFakeCircle:(e,t,o)=>({X:Math.ceil(e.X+t/2),Y:Math.ceil(e.Y+o/2)}),calcFakePin:(e,t,o)=>({X:Math.ceil(e.X+t/2),Y:Math.ceil(e.Y+o)})}})(),(()=>{const e=["wifi","dishwasher","parking","washer","elevator","conditioner"],t={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},o=(e,t,o)=>{0!==t.length||e.remove()},n=(e,t)=>{e.textContent=t};window.card={fill:(r,d)=>{let i=r.querySelector(".popup__title");o(i,d.offer.title,n(i,d.offer.title));let a=r.querySelector(".popup__text--address");o(a,d.offer.address,n(a,d.offer.address));let s=r.querySelector(".popup__type");o(s,d.offer.type,n(s,t[d.offer.type]));let l=r.querySelector(".popup__description");o(l,d.offer.description,n(l,d.offer.description));let c=r.querySelector(".popup__text--price");o(c,d.offer.price,c.textContent=d.offer.price+"₽/ночь");let u=r.querySelector(".popup__text--capacity");o(u,d.offer.rooms,u.textContent=`${d.offer.rooms} комнаты для ${d.offer.guests} гостей`);let m=r.querySelector(".popup__text--time");o(m,d.offer.checkin,m.textContent=`Заезде после ${d.offer.checkin}, выезд до ${d.offer.checkout}`);let w=r.querySelector(".popup__avatar");o(w,d.author.avatar,w.src=""+d.author.avatar);let p=r.querySelector(".popup__features"),f=p.querySelectorAll(".popup__feature");if(0!==d.offer.features.length)for(let t=0;t<d.offer.features.length;t++)!1===d.offer.features.includes(e[t])&&f[t].remove();else p.remove();let v=r.querySelector(".popup__photos"),y=v.querySelector(".popup__photo");if(0!==d.offer.photos.length){y.src=""+d.offer.photos[0];let e=document.createDocumentFragment();for(let t=1;t<d.offer.photos.length;t++)window.common.create(y,e),y.src=""+d.offer.photos[t];v.appendChild(e)}else v.remove()},remove:()=>{window.map.elementsParent.querySelectorAll(".map__card").forEach((e=>{e.remove()}))},hide:()=>{window.map.elementsParent.querySelectorAll(".map__card").forEach((e=>{e.style.display="none"}))}}})(),(()=>{let e;const t=document.querySelector(".map__filters"),o=Array.from(t.children),n={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},r={"housing-type":(e,t)=>t.value===e.offer.type,"housing-rooms":(e,t)=>t.value===e.offer.rooms.toString(),"housing-guests":(e,t)=>t.value===e.offer.guests.toString(),"housing-price":(e,t)=>e.offer.price>=n[t.value].start&&e.offer.price<n[t.value].end,"housing-features":(e,t)=>Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((t=>e.offer.features.some((e=>e===t.value))))},d=e=>e.filter((e=>o.every((t=>"any"===t.value||r[t.id](e,t)))));t.addEventListener("change",(()=>{window.map.clear();let t=d(e);window.debounce((()=>window.map.fill(t,5)))})),window.filter={success:t=>{e=t;let o=d(e);window.map.fill(o,5)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.image={load:(t,o)=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){if(null===o.querySelector("img")){const t=document.createElement("img");t.src=e.result,t.alt="Фото объявления",t.style="width: 65px; height: 65px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)",o.style.position="relative",o.appendChild(t)}else o.querySelector("img").src=e.result})),e.readAsDataURL(n)}}}})(),(()=>{const e={X:65,Y1:65,Y2:82},t=document.querySelector(".map"),o=t.querySelector(".map__filters"),n=o.children,r=document.querySelector(".map__pins"),d=r.querySelector(".map__pin--main"),i=window.pin.calcReal(e.X,e.Y1),a=document.querySelector("#pin").content.querySelector(".map__pin"),s=document.querySelector("#card").content.querySelector(".map__card"),l=e=>window.common.enterEvt(e,u),c=e=>window.common.leftButtonEvt(e,u),u=()=>{t.classList.remove("map--faded"),window.form.parent.classList.remove("ad-form--disabled"),[].forEach.call(n,(e=>e.removeAttribute("disabled",!0))),window.form.childs.forEach((e=>e.removeAttribute("disabled",!0)));const o=window.pin.calcFakePin(i,e.X,e.Y2);window.form.address.value=`${o.X}, ${o.Y}`,window.server.download(window.server.url.download,window.filter.success,window.server.error),d.removeEventListener("mousedown",c),d.removeEventListener("keydown",l),window.form.avatarChoser.addEventListener("change",window.form.onAvatarChose),window.form.adPhotoChoser.addEventListener("change",window.form.onPhotoChose)};window.map={elementsParent:r,mainPin:d,MainPinSizes:e,clear:()=>{window.pin.remove(),window.card.remove()},fill:(e,t)=>{for(let o=0;o<e.length&&o<t;o++)window.common.create(a,r),window.common.create(s,r);const o=r.querySelectorAll("button:not(.map__pin--main):not(.popup__close)"),n=r.querySelectorAll(".map__card");window.card.hide();for(let r=0;r<e.length&&r<t;r++){let t=o[r],d=n[r],i=d.querySelector(".popup__close");window.pin.fill(t,e[r]),window.card.fill(d,e[r]);const a=()=>{d.style.display="none",document.removeEventListener("keydown",s)},s=e=>{window.common.escEvt(e,a)},l=()=>{window.card.hide(),d.style.display="block",i.addEventListener("click",a),document.addEventListener("keydown",s)};t.addEventListener("click",l)}},onPageLock:()=>{window.map.clear(),window.form.parent.reset(),o.reset(),t.classList.add("map--faded"),window.form.parent.classList.add("ad-form--disabled"),[].forEach.call(n,(e=>e.setAttribute("disabled",!0))),window.form.childs.forEach((e=>e.setAttribute("disabled",!0))),window.pin.set(d,i);const r=window.pin.calcFakeCircle(i,e.X,e.Y1);window.form.address.value=`${r.X}, ${r.Y}`,d.addEventListener("mousedown",c),d.addEventListener("keydown",l)}}})(),(()=>{const e=window.map.mainPin;e.addEventListener("mousedown",(t=>{t.preventDefault(),window.startCoords={X:t.clientX,Y:t.clientY};const o=t=>{t.preventDefault();let o=window.startCoords.X-t.clientX,n=window.startCoords.Y-t.clientY;window.startCoords={X:t.clientX,Y:t.clientY};let r=e.offsetLeft-o,d=e.offsetTop-n,i=Math.round(r+window.map.MainPinSizes.X/2),a=Math.round(d+window.map.MainPinSizes.Y2);0<=i&&i<=1200&&130<=a&&a<=630&&(e.style.top=d+"px",e.style.left=r+"px",window.form.address.value=`${i}, ${a}`)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)}))})(),(()=>{const e=document.querySelector(".ad-form__submit");window.map.onPageLock(),window.form.parent.addEventListener("submit",(e=>{e.preventDefault()})),e.addEventListener("keydown",window.form.onButtonPressEnter),e.addEventListener("mousedown",window.form.onButtonPressLeftMouse)})()})();